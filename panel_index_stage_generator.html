<html>
<head>
  <title>PANEL[STAGE_GENEARTOR]</title>
	<link rel="stylesheet" type="text/css" href="/resource/main.css" media="all">
  <!-- icon -->
  <link rel="SHORTCUT ICON" href="/resource/favicon.ico">
</head>
<body bgcolor="#ffffff">

<!--mobile setting  -->
<meta name="viewport" content="width=device-width,initial-scale=0.8,maximum-scale=0.8">

<!--キャンバス　描画エリア-->
	<div class="canvas-wrapper">
		<!-- 46pix * 8_col * 10_row-->
		<table id="panels" border="1">
			<td id="p_0_0" width="46" height="46">
				<img id="i_0_0" src="/static/images/img/ggame_panelame/panel.png">
			</td>
			<td id="p_0_1" width="46" height="46">
				<img id="i_0_1" src="/resource/panel.png">
			</td>
			<td id="p_0_2" width="46" height="46">
				<img id="i_0_2" src="/resource/panel.png">
			</td>
			<td id="p_0_3" width="46" height="46">
				<img id="i_0_3" src="/resource/panel.png">
			</td>
			<td id="p_0_4" width="46" height="46">
				<img id="i_0_4" src="/resource/panel.png">
			</td>
			<td id="p_0_5" width="46" height="46">
				<img id="i_0_5" src="/resource/panel.png">
			</td>
			<td id="p_0_6" width="46" height="46">
				<img id="i_0_6" src="/resource/panel.png">
			</td>
			<td id="p_0_7" width="46" height="46" >
				<img id="i_0_7" src="/resource/panel.png">
			</td>

			<tr></tr>
			<td id="p_1_0" width="46" height="46" >
				<img id="i_1_0" src="/resource/panel.png">
			</td>
			<td id="p_1_1" width="46" height="46" >
				<img id="i_1_1" src="/resource/panel.png">
			</td>
			<td id="p_1_2" width="46" height="46" >
				<img id="i_1_2" src="/resource/panel.png">
			</td>
			<td id="p_1_3" width="46" height="46" >
				<img id="i_1_3" src="/resource/panel.png">
			</td>
			<td id="p_1_4" width="46" height="46" >
				<img id="i_1_4" src="/resource/panel.png">
			</td>
			<td id="p_1_5" width="46" height="46" >
				<img id="i_1_5" src="/resource/panel.png">
			</td>
			<td id="p_1_6" width="46" height="46" >
				<img id="i_1_6" src="/resource/panel.png">
			</td>
			<td id="p_1_7" width="46" height="46" >
				<img id="i_1_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_2_0" width="46" height="46" >
				<img id="i_2_0" src="/resource/panel.png">
			</td>
			<td id="p_2_1" width="46" height="46" >
				<img id="i_2_1" src="/resource/panel.png">
			</td>
			<td id="p_2_2" width="46" height="46" >
				<img id="i_2_2" src="/resource/panel.png">
			</td>
			<td id="p_2_3" width="46" height="46" >
				<img id="i_2_3" src="/resource/panel.png">
			</td>
			<td id="p_2_4" width="46" height="46" >
				<img id="i_2_4" src="/resource/panel.png">
			</td>
			<td id="p_2_5" width="46" height="46" >
				<img id="i_2_5" src="/resource/panel.png">
			</td>
			<td id="p_2_6" width="46" height="46" >
				<img id="i_2_6" src="/resource/panel.png">
			</td>
			<td id="p_2_7" width="46" height="46" >
				<img id="i_2_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_3_0" width="46" height="46" >
				<img id="i_3_0" src="/resource/panel.png">
			</td>
			<td id="p_3_1" width="46" height="46" >
				<img id="i_3_1" src="/resource/panel.png">
			</td>
			<td id="p_3_2" width="46" height="46" >
				<img id="i_3_2" src="/resource/panel.png">
			</td>
			<td id="p_3_3" width="46" height="46" >
				<img id="i_3_3" src="/resource/panel.png">
			</td>
			<td id="p_3_4" width="46" height="46" >
				<img id="i_3_4" src="/resource/panel.png">
			</td>
			<td id="p_3_5" width="46" height="46" >
				<img id="i_3_5" src="/resource/panel.png">
			</td>
			<td id="p_3_6" width="46" height="46" >
				<img id="i_3_6" src="/resource/panel.png">
			</td>
			<td id="p_3_7" width="46" height="46" >
				<img id="i_3_7" src="/resource/panel.png">
			</td>

			<tr></tr>
			<td id="p_4_0" width="46" height="46" >
				<img id="i_4_0" src="/resource/panel.png">
			</td>
			<td id="p_4_1" width="46" height="46" >
				<img id="i_4_1" src="/resource/panel.png">
			</td>
			<td id="p_4_2" width="46" height="46" >
				<img id="i_4_2" src="/resource/panel.png">
			</td>
			<td id="p_4_3" width="46" height="46" >
				<img id="i_4_3" src="/resource/panel.png">
			</td>
			<td id="p_4_4" width="46" height="46" >
				<img id="i_4_4" src="/resource/panel.png">
			</td>
			<td id="p_4_5" width="46" height="46" >
				<img id="i_4_5" src="/resource/panel.png">
			</td>
			<td id="p_4_6" width="46" height="46" >
				<img id="i_4_6" src="/resource/panel.png">
			</td>
			<td id="p_4_7" width="46" height="46" >
				<img id="i_4_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_5_0" width="46" height="46" >
				<img id="i_5_0" src="/resource/panel.png">
			</td>
			<td id="p_5_1" width="46" height="46" >
				<img id="i_5_1" src="/resource/panel.png">
			</td>
			<td id="p_5_2" width="46" height="46" >
				<img id="i_5_2" src="/resource/panel.png">
			</td>
			<td id="p_5_3" width="46" height="46" >
				<img id="i_5_3" src="/resource/panel.png">
			</td>
			<td id="p_5_4" width="46" height="46" >
				<img id="i_5_4" src="/resource/panel.png">
			</td>
			<td id="p_5_5" width="46" height="46" >
				<img id="i_5_5" src="/resource/panel.png">
			</td>
			<td id="p_5_6" width="46" height="46" >
				<img id="i_5_6" src="/resource/panel.png">
			</td>
			<td id="p_5_7" width="46" height="46" >
				<img id="i_5_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_6_0" width="46" height="46" >
				<img id="i_6_0" src="/resource/panel.png">
			</td>
			<td id="p_6_1" width="46" height="46" >
				<img id="i_6_1" src="/resource/panel.png">
			</td>
			<td id="p_6_2" width="46" height="46" >
				<img id="i_6_2" src="/resource/panel.png">
			</td>
			<td id="p_6_3" width="46" height="46" >
				<img id="i_6_3" src="/resource/panel.png">
			</td>
			<td id="p_6_4" width="46" height="46" >
				<img id="i_6_4" src="/resource/panel.png">
			</td>
			<td id="p_6_5" width="46" height="46" >
				<img id="i_6_5" src="/resource/panel.png">
			</td>
			<td id="p_6_6" width="46" height="46" >
				<img id="i_6_6" src="/resource/panel.png">
			</td>
			<td id="p_6_7" width="46" height="46" >
				<img id="i_6_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_7_0" width="46" height="46" >
				<img id="i_7_0" src="/resource/panel.png">
			</td>
			<td id="p_7_1" width="46" height="46" >
				<img id="i_7_1" src="/resource/panel.png">
			</td>
			<td id="p_7_2" width="46" height="46" >
				<img id="i_7_2" src="/resource/panel.png">
			</td>
			<td id="p_7_3" width="46" height="46" >
				<img id="i_7_3" src="/resource/panel.png">
			</td>
			<td id="p_7_4" width="46" height="46" >
				<img id="i_7_4" src="/resource/panel.png">
			</td>
			<td id="p_7_5" width="46" height="46" >
				<img id="i_7_5" src="/resource/panel.png">
			</td>
			<td id="p_7_6" width="46" height="46" >
				<img id="i_7_6" src="/resource/panel.png">
			</td>
			<td id="p_7_7" width="46" height="46" >
				<img id="i_7_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_8_0" width="46" height="46" >
				<img id="i_8_0" src="/resource/panel.png">
			</td>
			<td id="p_8_1" width="46" height="46" >
				<img id="i_8_1" src="/resource/panel.png">
			</td>
			<td id="p_8_2" width="46" height="46" >
				<img id="i_8_2" src="/resource/panel.png">
			</td>
			<td id="p_8_3" width="46" height="46" >
				<img id="i_8_3" src="/resource/panel.png">
			</td>
			<td id="p_8_4" width="46" height="46" >
				<img id="i_8_4" src="/resource/panel.png">
			</td>
			<td id="p_8_5" width="46" height="46" >
				<img id="i_8_5" src="/resource/panel.png">
			</td>
			<td id="p_8_6" width="46" height="46" >
				<img id="i_8_6" src="/resource/panel.png">
			</td>
			<td id="p_8_7" width="46" height="46" >
				<img id="i_8_7" src="/resource/panel.png">
			</td>	

			<tr></tr>
			<td id="p_9_0" width="46" height="46" >
				<img id="i_9_0" src="/resource/panel.png">
			</td>
			<td id="p_9_1" width="46" height="46" >
				<img id="i_9_1" src="/resource/panel.png">
			</td>
			<td id="p_9_2" width="46" height="46" >
				<img id="i_9_2" src="/resource/panel.png">
			</td>
			<td id="p_9_3" width="46" height="46" >
				<img id="i_9_3" src="/resource/panel.png">
			</td>
			<td id="p_9_4" width="46" height="46" >
				<img id="i_9_4" src="/resource/panel.png">
			</td>
			<td id="p_9_5" width="46" height="46" >
				<img id="i_9_5" src="/resource/panel.png">
			</td>
			<td id="p_9_6" width="46" height="46" >
				<img id="i_9_6" src="/resource/panel.png">
			</td>
			<td id="p_9_7" width="46" height="46" >
				<img id="i_9_7" src="/resource/panel.png">
			</td>	

		</table>
		
		
	</div>
	<!--ボタン-->
	<center>
	<div id="button-wrapper">
		<table>
			<td>
				<button type="button" style="height: 50px;" id="clear-button">
					<img src="/resource/retry.png" alt="RETRY" style="height: 100%;">
				</button>
			</td>
			<td>
				overlap(1-):<input type="text" id="overlap_manual" size="3" value="3" />
				&nbsp;&nbsp;<button type="button" style="height: 50px;" id="gen-button">
					stage gen
				</button>
			</td>
			<td>
				<div id="next"></div>
			</td>
		</table>
	</div>
	<hr>
	Auto STAGE_GENEARTOR:<br />
	panel size:<input type="text" id="size" size="5" /> 
	&nbsp;&nbsp;straight rate(0-100):<input type="text" id="rate" size="3" />
	&nbsp;&nbsp;overlap(1-):<input type="text" id="overlap" size="3" value="3" />
	&nbsp;&nbsp;<button type="button" style="height: 50px;" id="autogen-button">auto gen</button>
	<hr />
	<br />
	<textarea id="code" cols="100" rows="40"></textarea>
	</center>
	<br /><br />
<!--MESSAGE-->
<div id="message"></div>
<div id="message2"></div>
<script type="text/javascript" src="/resource/jqmin.js"></script>
<script type="text/javascript" src="/resource/gifer.js"></script>
<script>
/*!
 * panel game 0.1 by @kittens-labs
 * https://kittens-labs.onrender.com
 * License MIT
 *
 * The MIT License (MIT)
 *
 * Copyright (c) kittens-labs
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
//zoom cancel
document.addEventListener('touchstart', function(event) {
	    if (event.touches.length > 1) {
	        event.preventDefault();
	    }
}, { passive: false });
document.addEventListener("dblclick", function(e){
	e.preventDefault();}, { passive: false });

//cookie
const cookies = document.cookie;
const array = cookies.split(';');
let start_flg=false;
function getCookie(key){
	let ret;
	array.forEach(function(value){
						const content = value.split('=');
						if(content[0].trim() == key){
							ret = content[1].trim();
							try{
								if(isNaN(ret)){
									throw new Error('number format error.');
								}
							}catch(e){
								ret = undefined;
							}
							return ret;
						}
	})
	return ret;
}
function setCookie(key, value){
	document.cookie = key+'='+value;
}

//url param
const urlParams = new URLSearchParams(window.location.search);
const stage = urlParams.get('stage');
const num  = urlParams.get('num');
try{
	_stage = parseInt(stage);
	_num  = parseInt(num);
	if(isNaN(_stage) || isNaN(_num)){
		throw new Error('number format error.');
	}
}catch(e){
	_stage = 1;
	_num = 20;
}

//background pic layer
/*
var bg_pic = new Image();
bg_pic.onload = function() {
        // 画像サイズ取得
        var width = bg_pic.width;
        var height = bg_pic.height;
        // canvasの定義
        var canvas = document.getElementById('wallpaper-area');
        var ctx = canvas.getContext('2d');
        canvas.width = width;
        canvas.height = height;
        // 画像を canvas に表示
        ctx.drawImage(bg_pic, 0, 0);
}
bg_pic.src = "/resource/0.jpg";
*/

//effect animation layer
/*
var bg_pic2 = new Image();
bg_pic2.onload = function() {
        // 画像サイズ取得
        var width = bg_pic2.width;
        var height = bg_pic2.height;
        // canvasの定義
        var canvas = document.getElementById('animation-area');
        var ctx = canvas.getContext('2d');
        canvas.width = width;
        canvas.height = height;
        // 画像を canvas に表示
        ctx.drawImage(bg_pic2, 20, 10);
}
bg_pic2.src = "/resource/giphy5.gif";
*/
/*
function addGif(){
  let image = new Image();
  image.onload = () => {
    const canvas = document.getElementById('animation-area');
    canvas.width = 400;
    canvas.height = 600;
    
    const onDrawFrame = (ctx, frame) => {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.drawImage(frame.buffer, 50, 30, 100, 100);
    };

    gifler(image.src)
      .get()
      .then((animator) => {
        giflerAnimator = animator;
        animator.onDrawFrame = onDrawFrame;
        animator.animateInCanvas(canvas, false);
      });
  };
  image.src = "/resource/giphy5.gif";
};
addGif();
*/array
//button layer
const col_max = 8;
const row_max = 10;
$(document).ready(function() {
	//set roll over lock
	matrix_movelock = Array.from({ length: 10 }, () => new Array(8).fill(false));
	//now position
	matrix_now = [-1,-1]
	//start flg
	isStarted = false;

	//load panel param : level design
	matrix = [
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
		[0, 0, 0, 0 ,0 ,0 ,0, 0],
	];

	function initPanel(_matrix){
		for(i = 0; i < row_max; i++){
			for(j = 0; j < col_max; j++){
				$("#i_"+i+"_"+j).attr('src','/resource/panel'+_matrix[i][j]+'.gif');
			}
		}
	}
	initPanel(matrix);

	/*
	canvas.addEventListener('mousedown', startDrawing);
  	canvas.addEventListener('mousemove', draw);
  	canvas.addEventListener('mouseup', mouseup);
  	canvas.addEventListener('mouseout', mouseup);
  	canvas.addEventListener('touchstart', startDrawing);
  	canvas.addEventListener('touchmove', draw);
  	canvas.addEventListener('touchend', mouseup);
  	canvas.addEventListener('touchcancel', mouseup);
  	canvas.addEventListener('pointerout', mouseup);
	*/

	//click mousemove でもok
	for(i = 0; i < row_max; i++){
		for(j = 0; j < col_max; j++){
			//pc
			$("#i_"+i+"_"+j).on('click',{i:i,j:j},startGame);
			$("#i_"+i+"_"+j).on('mousemove',{i:i,j:j},moveEvent);

			$("#i_"+i+"_"+j).on('mouseout',{i:i,j:j},outEvent)

			//sp tablet
			$("#i_"+i+"_"+j).on('touchstart',{i:i,j:j},startTouchGame);
			$("#i_"+i+"_"+j).on('touchmove',{i:i,j:j},moveEvent);

			$("#i_"+i+"_"+j).on('touchend',{i:i,j:j},outEvent)
			$("#i_"+i+"_"+j).on('touchcancel',{i:i,j:j},outEvent)
			$("#i_"+i+"_"+j).on('pointerout',{i:i,j:j},outEvent)

		}
	}	
	$('#clear-button').on('click',function(){window.location.reload()});
	$('#gen-button').on('click',genCode);
	$('#autogen-button').on('click',autoGenCode);

	function startGame(event){
		if(!isStarted){
			isStarted = true;
		}else[
			isStarted = false
		]
		moveEvent(event);
	}

	function startTouchGame(event){
		isStarted = true;
		moveEvent(event);
	}

	function moveEvent(event){
				if(isStarted == false){
					return;
				}
				//clear check
				if(clearCheck() == true){
					//alert("clear");
				}

				//移動可能list以外return
				//初手
				if(matrix_now[0] == -1 && matrix_now[1] == -1
					 && !firstMovable(event.data.i, event.data.j)){
					return;
				}
				//初手以外
				if(matrix_now[0] >= 0 && matrix_now[1] >= 0
					 && !isMovable(event.data.i, event.data.j)){
					return;
				}

				//更新可能のパネルかチェック
				//if(matrix[event.data.i][event.data.j] <= 0 || matrix_movelock[event.data.i][event.data.j] == true){
				//	return;
				//}
				//現在地更新
				matrix_now[0] = event.data.i;
				matrix_now[1] = event.data.j;

				//table color clear
				for(i = 0; i < row_max; i ++){
					for(j = 0; j < col_max; j++){
						$("#p_"+i+"_"+j).removeAttr('style');
					}
				}

				if(matrix_now[0] == -1 && matrix_now[1] == -1){
					//初手
					//panel更新
					panelUpdate();

					//移動可能範囲ハイライト表示
					list_array = listOfMovable(event.data.i, event.data.j);
					viewHighLight(list_array);
				}else{
					//初手以外
					//panel更新
					panelUpdate();

					//移動可能範囲ハイライト表示
					list_array = listOfMovable(matrix_now[0], matrix_now[1]);
					viewHighLight(list_array);
				}

				function panelUpdate(){
					matrix[event.data.i][event.data.j]+=1;
					$("#i_"+event.data.i+"_"+event.data.j).attr('src','/resource/panel'+matrix[event.data.i][event.data.j]+'.gif');
					//move検知lock
					matrix_movelock[event.data.i][event.data.j] = true;
				}	
	}

	function outEvent(event){
		//move検知lock解除
		matrix_movelock[event.data.i][event.data.j] = false;
	}

	function viewHighLight(list_array){
		for(i = 0; i < list_array.length; i++){
			$("#p_"+list_array[i][0]+"_"+list_array[i][1]).attr('style','background-color: #ff0000;');
		}
	}

	//clear check
	function clearCheck(){
		for(i = 0; i < row_max; i++){
			for(j = 0; j < col_max; j++){
				if(matrix[i][j] > 0){
					return false;
				}
			}
		}
		return true;
	}

	//初手の移動可能かチェック
	function firstMovable(x, y){
		//if(matrix[x][y] >= 1){
			return true;
		//}
		//return false;
	}

	//初手以外の移動可能かチェック
	function isMovable(y, x){
		list_array = listOfMovable(matrix_now[0], matrix_now[1]);
		for(i = 0; i < list_array.length; i++){
			if(y == list_array[i][0] && x == list_array[i][1]){
				return true;
			}
		}
		return false;
	}

	//移動可能ポジションリスト：ハイライト表示用
	function listOfMovable(y,x){
		overlap_max = $("#overlap_manual").val();
		if(y < 0 || x < 0){
			return new Array();
		}
		ret_array = new Array();
		if(y - 1 >= 0){
			if(matrix[y-1][x] < overlap_max){ 
				ret_array.push([y-1, x])
			}
		}
		if(x - 1 >= 0){
			if(matrix[y][x-1] < overlap_max){ 
				ret_array.push([y, x-1])
			}
		}
		if(y + 1 < row_max){
			if(matrix[y+1][x] < overlap_max){ 
				ret_array.push([y+1, x])
			}
		}
		if(x + 1 < col_max){
			if(matrix[y][x+1] < overlap_max){ 
				ret_array.push([y, x+1])
			}
		}
		return ret_array;
	}

	function genCode(){
		str = "stage_matrix = [\n";
		for(i = 0; i < matrix.length; i++){
			str+="[";
			for(j = 0; j < matrix[i].length; j++){
				str+= matrix[i][j]+",";
			}
			str+="],\n";
		}
		str+="]\n"
		str += "window.panelLib= window.panelLib|| {};\n"
		str += "window.panelLib.stage_matrix = stage_matrix; \n"
		$("#code").val(str);
	}
	function autoGenCode(){
		size = $("#size").val();
		rate = $("#rate").val();
		overlap_max = $("#overlap").val();
		try{
			if(size == undefined || rate == undefined || overlap_max == undefined
			|| isNaN(size) || isNaN(rate) || isNaN(overlap_max)
			|| size.length == 0 || rate.length == 0 || overlap_max.length == 0
			|| rate < 0 || rate > 100
			|| size < 2 || size > 1000
			|| overlap_max < 1 || overlap_max > 9
			){
				throw new Error("number format exception")
			}
		}catch(e){
			return;
		}
		//init position
		row = getRandomInt(row_max);
		col = getRandomInt(col_max);
		matrix[row][col]+=1;
		movable_list = listOfMovable(row,col);
		next_pos = movable_list[getRandomInt(movable_list.length)];
		matrix[next_pos[0]][next_pos[1]]+=1;
		matrix_now[0] = next_pos[0];
		matrix_now[1] = next_pos[1];
		angle = getAngle(row, col, next_pos[0], next_pos[1]);

		//next position 
		for(i = 0; i < size-2; i++){

			let choices = [
				{ name: 'hit', weight: parseInt(rate) }, //hit
				{ name: 'others', weight: parseInt(100-rate) },  //other
			];
			result = weightedRandom(choices);
			movable_list = listOfMovable(matrix_now[0],matrix_now[1]);
			if(movable_list.length == 0){
				//alert("none list")
				initPanel(matrix);
				genCode();
				return;
			}
			updateFlg = false;
			if(result == "hit"){
				for(j = 0; j < movable_list.length; j++){
					tmp_angle  = getAngle(matrix_now[0], matrix_now[1], movable_list[j][0], movable_list[j][1]);
					if(angle == tmp_angle){
						matrix[movable_list[j][0]][movable_list[j][1]] +=1;
						matrix_now[0] = movable_list[j][0];
						matrix_now[1] = movable_list[j][1];
						updateFlg = true;
					}
				}
			}
			if(updateFlg == false){
				let choices2 = [];
				if(movable_list.length >=3){
					choices2 = [
						{ name: parseInt(0), weight: parseInt(33) }, 
						{ name: parseInt(1), weight: parseInt(33) },  
						{ name: parseInt(2), weight: parseInt(34) },  
					];
				}else if(movable_list.length ==2) {
					choices2 = [
						{ name: parseInt(0), weight: parseInt(50) },
						{ name: parseInt(1), weight: parseInt(50) },  
					];
				}else if(movable_list.length ==1) {
					choices2 = [
						{ name: parseInt(0), weight: parseInt(100) },
					];
				}else{
					choices2 = [
						{ name: parseInt(0), weight: parseInt(100) },
					];
				}
				result2 = weightedRandom(choices2);
				matrix[movable_list[result2][0]][movable_list[result2][1]] +=1;
				matrix_now[0] = movable_list[result2][0];
				matrix_now[1] = movable_list[result2][1];		
			}
		}
		initPanel(matrix);
		genCode();

	}
	function getAngle(nowy, nowx, nexty, nextx){
		//up 0
		//right 1
		//down 2
		//left 3
		if(nowy > nexty && nowx > nextx){
			//up
			return 0;
		}
		if(nowy == nexty && nowx < nextx){
			//right
			return 1;
		}
		if(nowy < nexty && nowx < nextx){
			//down
			return 2;
		}if(nowy == nexty && nowx > nextx){
			//left
			return 3;
		}
	}
	function getRandomInt(max) {
		return Math.floor(Math.random() * max);
	}
	function weightedRandom(items) {
		// itemsは { name: 'A', weight: 5 }, { name: 'B', weight: 3 }, { name: 'C', weight: 2 } のような配列
		let totalWeight = items.reduce((sum, item) => sum + item.weight, 0); // 全重みを計算
		let randomValue = Math.random() * totalWeight; // 全重みの範囲でランダムな値

		let cumulativeWeight = 0;
		for (const item of items) {
			cumulativeWeight += item.weight;
			if (randomValue < cumulativeWeight) {
			return item.name; // そのアイテムの範囲内であればそれを返す
			}
		}
		// 念のため、最後のアイテムを返す（浮動小数点誤差対策）
		return items[items.length - 1].name;
	}
});

</script>
</body>
</html>